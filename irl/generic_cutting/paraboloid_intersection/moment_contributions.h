// This file is part of the Interface Reconstruction Library (IRL),
// a library for interface reconstruction and computational geometry operations.
//
// Copyright (C) 2022 Fabien Evrard <fa.evrard@gmail.com>
//
// This Source Code Form is subject to the terms of the Mozilla Public
// License, v. 2.0. If a copy of the MPL was not distributed with this
// file, You can obtain one at https://mozilla.org/MPL/2.0/.

#ifndef IRL_GENERIC_CUTTING_PARABOLOID_INTERSECTION_MOMENT_CONTRIBUTIONS_H_
#define IRL_GENERIC_CUTTING_PARABOLOID_INTERSECTION_MOMENT_CONTRIBUTIONS_H_

#include <float.h>
#include <cassert>
#include <cmath>

#include "irl/data_structures/small_vector.h"
#include "irl/data_structures/stack_vector.h"
#include "irl/generic_cutting/half_edge_cutting/half_edge_cutting_helpers.h"
#include "irl/geometry/general/normal.h"
#include "irl/geometry/general/pt.h"
#include "irl/geometry/general/reference_frame.h"
#include "irl/geometry/general/rotations.h"
#include "irl/geometry/general/unit_quaternion.h"
#include "irl/helpers/mymath.h"
#include "irl/paraboloid_reconstruction/paraboloid.h"

namespace IRL {

inline double signedDistance(const Pt& a_pt,
                             const AlignedParaboloid& a_paraboloid);

template <class ReturnType, class PtType>
ReturnType computeType1Contribution(const PtType& a_ref_pt,
                                    const PtType& a_pt_0, const PtType& a_pt_1);

template <class ReturnType, class PtType>
ReturnType computeType2Contribution(
    const AlignedParaboloid& a_aligned_paraboloid, const PtType& a_pt_0,
    const PtType& a_pt_1);

inline std::array<double, 3> coeffsV3SeriesOne(const double a_weight);
template <class GradientType>
inline std::array<std::pair<double, GradientType>, 3>
coeffsV3SeriesOneWithGradient(const double a_weight,
                              const GradientType& a_weight_grad);

inline std::array<double, 12> coeffsV3andC3SeriesOne(const double a_weight);
inline std::array<double, 3> coeffsV3SeriesInfinity(const double a_weight);
inline std::array<double, 12> coeffsV3andC3SeriesInfinity(
    const double a_weight);

inline std::array<double, 3> coeffsV3Exact(const double a_weight);

template <class GradientType>
inline std::array<std::pair<double, GradientType>, 3> coeffsV3ExactWithGradient(
    const double a_weight, const GradientType& a_weight_grad);

inline std::array<double, 12> coeffsV3andC3Exact(const double a_weight);

template <class ReturnType, class RationalBezierArcType>
ReturnType computeType3Contribution(const AlignedParaboloid& a_paraboloid,
                                    const RationalBezierArcType& a_arc);
template <class ReturnType, class PtType>
ReturnType computeFaceOnlyContribution(const AlignedParaboloid& a_paraboloid,
                                       const Plane& a_face_plane,
                                       const PtType& a_pt_ref);

template <class ReturnType, class PtType>
ReturnType computeTriangleCorrection(const AlignedParaboloid& a_paraboloid,
                                     const PtType& a_pt_0, const PtType& a_pt_1,
                                     const PtType& a_pt_2);

static double v3Series[41][3] = {
    {2.09523809523809528832e-01, 3.80952380952380931234e-01,
     -5.71428571428571410729e-02},
    {-1.26984126984126897281e-02, 2.53968253968253954156e-01,
     -1.26984126984126897281e-02},
    {-2.02020202020201967985e-02, -1.50072150072150078959e-01,
     3.05916305916305968082e-02},
    {3.72960372960372960049e-02, 6.39360639360639360085e-02,
     -2.27328227328227328030e-02},
    {-4.04040404040404005359e-02, -1.24320124320124320016e-02,
     1.06560106560106560014e-02},
    {3.56871886283650976979e-02, -1.17007175830705235225e-02,
     -1.96404902287255220608e-03},
    {-2.81279092424603222033e-02, 1.93985580982484993873e-02,
     -2.53258952949355449144e-03},
    {2.05862249205902465843e-02, -1.90026691574679169883e-02,
     4.08205485604866413762e-03},
    {-1.42950332747075244816e-02, 1.55257315036558540822e-02,
     -4.04150970849045942934e-03},
    {9.54264472907628141796e-03, -1.15117618953936087789e-02,
     3.34612217772804624097e-03},
    {-6.17719348100287651143e-03, 8.02232919610763178797e-03,
     -2.51160614062754345907e-03},
    {3.90101474890349820060e-03, -5.35157257972321016154e-03,
     1.76920699049727420810e-03},
    {-2.41399989775078170628e-03, 3.45489893623047647497e-03,
     -1.19128627544748053046e-03},
    {1.46860565623520115952e-03, -2.17399892419069132657e-03,
     7.75354403547797083919e-04},
    {-8.80620601999301463869e-04, 1.33998761306499628715e-03,
     -4.91374024102316972994e-04},
    {5.21508692652322930310e-04, -8.11929701135352872333e-04,
     3.04769590179816240831e-04},
    {-3.05509568942368672697e-04, 4.84935823718045519101e-04,
     -1.85693554017880819258e-04},
    {1.77276395815434737553e-04, -2.86091263576557155047e-04,
     1.11457242528130960613e-04},
    {-1.02003016912458784591e-04, 1.66992280852464172270e-04,
     -6.60467997392183550414e-05},
    {5.82514823061649380099e-05, -9.65689972832239939063e-05,
     3.87058390159377495678e-05},
    {-3.30420824175868270054e-05, 5.53862690352201691383e-05,
     -2.24639917748133214606e-05},
    {1.86285795481852382328e-05, -3.15342725894044787469e-05,
     1.29264281372589721935e-05},
    {-1.04445437246298650441e-05, 1.78365273922045843719e-05,
     -7.38180846738453570066e-06},
    {5.82652104120046942685e-06, -1.00291738167552344136e-05,
     4.18683046937667869923e-06},
    {-3.23537647052159395237e-06, 5.60903039441516042084e-06,
     -2.36015114894640314994e-06},
    {1.78895249909732800395e-06, -3.12166207896178048349e-06,
     1.32305364506587308319e-06},
    {-9.85314706294302336548e-07, 1.72957799169836069021e-06,
     -7.37930243147500172352e-07},
    {5.40730333792878414157e-07, -9.54352573707662287295e-07,
     4.09677505966842900732e-07},
    {-2.95753356068542047445e-07, 5.24603798556049428080e-07,
     -2.26476468134631995398e-07},
    {1.61258810015876044985e-07, -2.87363379726446506705e-07,
     1.24710685182335891934e-07},
    {-8.76704778002015941588e-08, 1.56898500301773665938e-07,
     -6.84246579715181159030e-08},
    {4.75337224703033490158e-08, -8.54066883855229413404e-08,
     3.74166200173413135769e-08},
    {-2.57065245781141249776e-08, 4.63595284039086283402e-08,
     -2.03967889080998694981e-08},
    {1.38690173306780284126e-08, -2.50980391851122611262e-08,
     1.10865459080972638555e-08},
    {-7.46569873014004157925e-09, 1.35539622702173452016e-08,
     -6.00967114184549464555e-09},
    {4.01027350117916946203e-09, -7.30270649187992777560e-09,
     3.24937617487547770152e-09},
    {-2.14984854345419424283e-09, 3.92601604195155335685e-09,
     -1.75271787826727456715e-09},
    {1.15032202162643386740e-09, -2.10632478621065486152e-09,
     9.43297274700691519062e-10},
    {-6.14401522453570845869e-10, 1.12785551663862354372e-09,
     -5.06601052225360602018e-10},
    {3.27602053250195924866e-10, -6.02812432885591007361e-10,
     2.71528967029476965440e-10},
    {-1.74397233757762826095e-10, 3.21627843814674501789e-10,
     -1.45260052080825577373e-10}};

static double cx3Series[41][4] = {
    {-0.0063492063492063492063, 0.0015873015873015873016,
     -0.0015873015873015873016, 0.015873015873015873016},
    {-0.0011544011544011544012, 0.00086580086580086580087,
     -0.0014430014430014430014, 0.02020202020202020202},
    {0.0011988011988011988012, -0.00063270063270063270063,
     0.00061050061050061050061, -0.0023310023310023310023},
    {-0.0010656010656010656011, 0.00035520035520035520036,
     -0.000088800088800088800089, -0.0024864024864024864025},
    {0.00086188321482439129498, -0.00014103543515308221191,
     -0.00012667071490600902366, 0.0024498377439553910142},
    {-0.0006532167522879597183, 9.8972235195145411864e-6,
     0.00016605341682741063546, -0.0014087048142775696955},
    {0.00047176765443019312988, 0.000054434729357329976525,
     -0.00013361251751344630602, 0.00057458880988292752999},
    {-0.00032818619438622130775, -0.000075735275627589532557,
     0.00008606281321316992336, -0.0001208704398904964257},
    {0.00022152568121069938273, 0.000073841893736899794243,
     -0.000046387856321898588691, -0.000062997979272040383899},
    {-0.00014586053083832058122, -0.000061990725606286247019,
     0.00001991557247984761782, 0.00010562138439376291039},
    {0.000094054894023330857545, 0.000047719027114778155666,
     -4.841060721789088256e-6, -0.000091182176671939530448},
    {-0.000059577293574895792463, -0.000034656072733109317184,
     -2.4174882196785057399e-6, 0.000062527702532727484548},
    {0.000037160584628786011965, 0.000024121783004650569171,
     5.057329306420180937e-6, -0.000036949662837807350391},
    {-0.00002286805207925293044, -0.000016248352793153397944,
     -5.3217190339231535751e-6, 0.000019003610873909620472},
    {0.00001390624788603218743, 0.00001066145671262467703,
     4.5730682619369006227e-6, -8.1043239959138047246e-6},
    {-8.3675200955270597869e-6, -6.8461528054312307347e-6,
     -3.5431843466705492399e-6, 2.2498651462407874425e-6},
    {4.9873481057181103303e-6, 4.3171116013923563729e-6,
     2.572525406309143866e-6, 4.7379979923956807104e-7},
    {-2.9473794550892252567e-6, -2.6804066783601287661e-6,
     -1.7846725620132935102e-6, -1.4624487685244401446e-6},
    {1.7284015323054098728e-6, 1.6419814556901393791e-6,
     1.1965594007244764396e-6, 1.5979174640562662816e-6},
    {-1.0064600188116608442e-6, -9.9407281858013271071e-7,
     -7.8103317111996543704e-7, -1.3806954534744485444e-6},
    {5.8230901088388948841e-7, 5.955810111319553457e-7,
     4.9883365932365860686e-7, 1.0666137424656333791e-6},
    {-3.3492282978942663386e-7, -3.5352965366661700241e-7,
     -3.1288089996567804343e-7, -7.6997401950661013392e-7},
    {1.9158964620029808301e-7, 2.081059950106686074e-7,
     1.9325539761877989658e-7, 5.3061805608865933269e-7},
    {-1.0904707135511037135e-7, -1.2158121748788167841e-7,
     -1.1779776226632293202e-7, -3.5334293595552945833e-7},
    {6.1777397880270860965e-8, 7.0545802740696402521e-8,
     7.0978725551203306219e-8, 2.2910878909869871006e-7},
    {-3.484664070263413988e-8, -4.067783259440557861e-8,
     -4.2334889201788903949e-8, -1.4540160292564178824e-7},
    {1.9576517570017035708e-8, 2.3321268090039233826e-8,
     2.5022811283848958256e-8, 9.0654067451795652618e-8},
    {-1.095640489515356731e-8, -1.3300020915507271547e-8,
     -1.4670634659668765008e-8, -5.5679210350078019557e-8},
    {6.1103027299894894613e-9, 7.5480210193987810992e-9,
     8.5384945568469436623e-9, 3.3760292170866975216e-8},
    {-3.3963597263966282132e-9, -4.264318323142433201e-9,
     -4.9365943997042850996e-9, -2.0241919565433302267e-8},
    {1.8819442541917548601e-9, 2.3990550627759757902e-9,
     2.8368788717797809749e-9, 1.2017477033745235504e-8},
    {-1.0397293108119826942e-9, -1.3444010576502023741e-9,
     -1.6212185104813679895e-9, -7.0724413330087291142e-9},
    {5.7283031807149902716e-10, 7.506319012785769978e-10,
     9.2176969750829607936e-10, 4.1296923866027286021e-9},
    {-3.147673666978742129e-10, -4.1767208273371770558e-10,
     -5.2161867565353216827e-10, -2.3943823289464639925e-9},
    {1.7253291490124121295e-10, 2.3165699915398362861e-10,
     2.938894699302504305e-10, 1.3793745290518573865e-9},
    {-9.434711295865342278e-11, -1.2809729970809041955e-10,
     -1.649107682676817358e-10, -7.9000403248570434467e-10},
    {5.1476768421542385337e-11, 7.0630914810953505462e-11,
     9.2186629097512589963e-11, 4.5003649993919639081e-10},
    {-2.8026426831917573521e-11, -3.8840005894972451254e-11,
     -5.1350951962311719752e-11, -2.5510769627974620503e-10},
    {1.5227981142419610381e-11, 2.1303791800253697351e-11,
     2.8509389642524600611e-11, 1.4395291852331000857e-10},
    {-8.2580269089455004717e-12, -1.1656982912047706463e-11,
     -1.5778810413025526031e-11, -8.0887864722304356489e-11},
    {4.4700050150387582609e-12, 6.3638646791347353965e-12,
     8.7073813105860396427e-12, 4.5273201016476705534e-11}};
static double cz3Series[41][5] = {
    {0.0014430014430014430014, -0.00038480038480038480038,
     0.00014430014430014430014, -0.0014430014430014430014,
     0.01010101010101010101},
    {0.00022200022200022200022, -0.00017760017760017760018,
     0.00011100011100011100011, -0.0015540015540015540016,
     0.013986013986013986014},
    {-0.00024420024420024420024, 0.00014800014800014800015,
     -0.000062900062900062900063, 0.00046620046620046620047,
     -0.00046620046620046620047},
    {0.00022983552395317101199, -0.000097505979858921035392,
     0.000020894138541197364727, 0.000073129484894190776544,
     -0.0021938845468257232963},
    {-0.00019656985601258047078, 0.000050402527182712941227,
     3.3907154650188705916e-6, -0.00021265284423179160021,
     0.0015992263670282246134},
    {0.00015725588481006437663, -0.000016128808698468141193,
     -0.00001282973419196329413, 0.00017815002335126174135,
     -0.00069610472087252273011},
    {-0.00011965121670330985178, -4.5581415886975181631e-6,
     0.000013586768197079140679, -0.00010418381666194292389,
     0.00015785354323515583443},
    {0.000087516318502992348732, 0.000014586053083832058122,
     -0.000010659038792031119397, 0.000044217160921966413957,
     0.000055998203797369230133},
    {-0.000061990725606286247019, -0.000017624814142963736897,
     6.9891504360028611835e-6, -8.9059074117628431803e-6,
     -0.00009862160891909175662},
    {0.000042752224556059480702, 0.000016765578257278227726,
     -3.8979969448171879464e-6, -6.9448183781110197159e-6,
     0.000077842110881318831523},
    {-0.000028823273974891714409, -0.000014158801250824000061,
     1.7475411207687184949e-6, 0.000011288372005646445426,
     -0.000046028688649353748743},
    {0.0000190567100660441087, 0.000011099697792853761559,
     -4.5232645151601083602e-7, -0.000010262893857549141512,
     0.0000214761271025309185},
    {-0.000012386861542928670655, -8.2579076952857804368e-6,
     -2.1731336040225737991e-7, 7.506898288013273315e-6,
     -6.9220696857542571308e-6},
    {7.9317117572183587563e-6, 5.9058632997470030566e-6,
     4.8974570202920374184e-7, -4.7664896434958622481e-6,
     -6.2347700073828520641e-8},
    {-5.0117958905500618515e-6, -4.0939571174453733174e-6,
     -5.4013821323714764091e-7, 2.6644779650280295543e-6,
     2.5535878641983134928e-6},
    {3.129316458489794717e-6, 2.7664971589547460542e-6,
     4.8444622381100247596e-7, -1.2730140076090687683e-6,
     -2.8421908841954876307e-6},
    {-1.9330806611310505156e-6, -1.8299830258707278214e-6,
     -3.909458254066090305e-7, 4.5370090773897936608e-7,
     2.2886034301954855353e-6},
    {1.1825905221037014919e-6, 1.1886550888837204739e-6,
     2.9518619609701088521e-7, -2.7110770862456397838e-8,
     -1.5708918519742657359e-6},
    {-7.1710276340330835147e-7, -7.6000634753854902207e-7,
     -2.1267919564183589569e-7, -1.5903154625307786913e-7,
     9.6179127904395480508e-7},
    {4.3134000806214036179e-7, 4.7926667562460040199e-7,
     1.4790906943122283175e-7, 2.1284249093474310695e-7,
     -5.2932548973547611658e-7},
    {-2.5753535775474851013e-7, -2.9855494675673636806e-7,
     -1.0002794304608458616e-7, -2.0266799790569782022e-7,
     2.5594175084284209823e-7},
    {1.5271638465241151544e-7, 1.8396180588014628526e-7,
     6.6118587991273951129e-8, 1.6766125596393132669e-7,
     -9.9328995650884827143e-8},
    {-8.9989076245594554139e-8, -1.1224443918805342237e-7,
     -4.2875774184497219899e-8, -1.2799849497640684564e-7,
     1.8624076183031950137e-8},
    {5.271671285783113469e-8, 6.787985338414277827e-8, 2.7352780888182218801e-8,
     9.2637846125540761576e-8, 1.7208448546633587978e-8},
    {-3.071418651674483483e-8, -4.0719565457805652237e-8,
     -1.7204297877573518063e-8, -6.4494123428475604319e-8,
     -2.8867704615203707214e-8},
    {1.7804157954624546879e-8, 2.4246660743909365089e-8,
     1.0687383212440838886e-8, 4.3578820145712258737e-8,
     2.8913677657207246703e-8},
    {-1.0271629589206469353e-8, -1.4340000524539227803e-8,
     -6.5662444945261498605e-9, -2.8749311366615881813e-8,
     -2.4343178014667874634e-8},
    {5.8996026358519208592e-9, 8.4280037655027440845e-9,
     3.9946634603336535688e-9, 1.8594692204666312808e-8,
     1.8699558468587231677e-8},
    {-3.3743462837255389562e-9, -4.9247216032751109091e-9,
     -2.4087145968088505427e-9, -1.1827586048012319188e-8,
     -1.3550052021182301534e-8},
    {1.9224161736367388356e-9, 2.8622033121002180862e-9,
     1.4407638710527403526e-9, 7.4159776532243140318e-9,
     9.4219910474639538606e-9},
    {-1.0911742506698672546e-9, -1.6551684989918094388e-9,
     -8.5548347806648417542e-10, -4.5920439932382481552e-9,
     -6.3506989392077571167e-9},
    {6.1719091509387100569e-10, 9.5268956637566755237e-10,
     5.0455588049226676099e-10, 2.8122335449444651528e-9,
     4.1764928467691314972e-9},
    {-3.4794137838416977946e-10, -5.4595679697678672712e-10,
     -2.9574616321726106118e-10, -1.7054145635905405755e-9,
     -2.6919658677594336999e-9},
    {1.9553730355474004135e-10, 3.1158789834739063499e-10,
     1.7236387076948473313e-10, 1.0251290979267524611e-9,
     1.7061340627605458517e-9},
    {-1.0956204089720169852e-10, -1.7714349912504372075e-10,
     -9.9924499407049177884e-11, -6.1131505302408927361e-10,
     -1.065885683044499708e-9},
    {6.1215616501293647428e-11, 1.0034356869768077795e-10,
     5.7644468794983971439e-11, 3.6191208900444418566e-10,
     6.5764432353207239796e-10},
    {-3.4111111604636520404e-11, -5.6645118664669130853e-11,
     -3.3101480394351295699e-11, -2.1284450653719036846e-10,
     -4.0134152620956508302e-10},
    {1.89590534451207115e-11, 3.1873191299043514985e-11,
     1.8926522667386031234e-11, 1.244163680840089353e-10,
     2.4255777605628953616e-10},
    {-1.0511780086178543309e-11, -1.7879426134863041903e-11,
     -1.0778162201445142786e-11, -7.2319167132292512211e-11,
     -1.4532375000586004028e-10},
    {5.814640669969116437e-12, 1.0000357180620643518e-11,
     6.1146962099380746966e-12, 4.1818733693205844297e-11,
     8.63870700505190207e-11},
    {-3.2092343697714161873e-12, -5.5779549760312709923e-12,
     -3.4566667496530258601e-12, -2.4065238374664231036e-11,
     -5.0987752482180218611e-11}};
}  // namespace IRL

#include "irl/generic_cutting/paraboloid_intersection/moment_contributions.tpp"

#endif  // IRL_GENERIC_CUTTING_PARABOLOID_INTERSECTION_MOMENT_CONTRIBUTIONS_H_
